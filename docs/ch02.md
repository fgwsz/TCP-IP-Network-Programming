# 第二章 套接字类型与协议设置
本章介绍套接字创建方法及不同套接字的特性.
## 2.1 套接字协议及其数据传输特性
`协议`一词给人的第一印象总是相当枯燥和困难,
但是各位要慢慢熟悉`协议`,因为它几乎是网络编程的全部内容.
### 关于协议(`Protocol`)
`协议`是为了完成数据交换而制定好的约定.

举个例子:

相隔很远的两人想展开对话,此时必须决定对话的方式,
即使用什么完成通信?
如果一方使用电话,那么另一方也只能使用电话,而不是书信.

在这里,电话就是两人对话的协议.
### 创建套接字
创建套接字的`socket()`已经在第一章中简要介绍过,
此处为了完全理解该函数,再次展开讨论.
#### `socket()`
```c
#include<sys/socket.h>

//domain:套接字中使用的协议族(Protocol Family)信息
//type:套接字数据传输类型信息
//protocol:计算机间数据通信中使用的协议信息
int socket(int domain,int type,int protocol);
    //成功时返回文件描述符
    //失败时返回-1
```
### 协议族(`Protocol Family`)
协议族是什么呢?
举一个例子:就像奶油意大利面和番茄意大利面都属于意大利面.

`socket()`函数的第一个参数就是需要传递套接字中使用的协议分类信息.
协议分类信息也称为`协议族`.

表2-1 头文件`sys/socket.h`中声明的协议族
名称|协议族
:----------:|:----:
`PF_INET`   |`IPv4`互联网协议族
`PF_INET6`  |`IPv6`互联网协议族
`PF_LOCAL`  |本地通信的`UNIX`协议族
`PF_PACKET` |底层套接字的协议族
`PF_IPX`    |`IPX Novell`协议族
### 套接字类型(`Type`)
套接字类型指的是套接字的数据传输方式,通过`socket()`的第二个参数传递.

在一个协议族中也许会存在多种数据传输方式.

下面介绍2种具有代表性的数据传输方式.
#### 套接字类型1:面向连接的套接字(`SOCK_STREAM`)
面向连接的套接字是怎么样传输数据的呢?

举一个例子:

两个工人通过一条传送带传递物品,只要传送带本身没有问题,就能保证数据不丢失,
而且传送带保证了数据的按序传递.
除此之外,还有一个重要的特点,传输的数据是一个整体,
发送方可以使用每次发送的是一个完整数据的一部分进行多次发送,
而且发送的这些数据没有数据边界(`Boundary`),
这里的数据边界可能代表的是对一个数据包整体的包装的那部分标识信息.

"100个糖果是分批传递的,但接收者凑齐100个之后才能装袋."

这里我发现了这种传输方式存在的的一个隐含的问题:

接收端怎么确定本次数据传输的数据已经全部发送完毕了呢?
我想了如下的两种方式用来解决:

1. 在传输的数据中使用类似`EOF`这样的标识符,接受到此符号之后,代表数据传输完毕
2. 在第一次传输数据的时候,就给出完整数据包的字节大小,
等到接收端接收到指定指定大小的数据之后,代表数据传输完毕.

"传输数据的计算机通过3次调用`write`函数传输了100字节的数据,
但接收数据的计算机可能仅仅通过一次`read`函数调用就接收了全部100个字节的数据."

总结一下,面向连接的套接字的传输方式的特点:

1. 传输过程中数据不会消失
2. 按顺序传输数据
3. 传输的数据不存在数据边界(`Boundary`)
4. (隐藏特性)需要用户自己制定接收方确保已完成接收全部数据的策略

另一个隐含的问题:接收方套接字的缓冲区溢出问题

收发数据的套接字内部有缓冲区`buffer`,可以看作是一个固定大小的字节数组.
但是这带来一个问题,发送方给接收方发送了很多数据,
这些数据都是缓存在接收方套接字的缓冲区内,
缓冲区数组的是存在存储上限的,
而此时接收方迟迟不调用`read`函数读取存放在缓冲区的数据,
以此来缩减缓冲区内的数据大小,
这直接导致缓冲区存储的数据量持续飙升,
终于缓冲区填满了,而这时候发送方又发来一些新数据,
那么这时候会发生什么呢?
1. 发送方套接字不会察觉到接收方套接字缓冲区已满,
继续发送新数据,导致新数据直接覆盖了缓冲区中未被读取的旧数据,
造成数据丢失.
2. 发送方套接字会察觉到接收方套接字缓冲区已满,过一段时间再查询一下,
直到接收方缓冲区有足够的写入空间,这时再写入新数据.

正确答案是2.(`TCP`的滑动窗口机制已经使用类似的处理思路完美解决了这个问题).

因此,不要轻易担心面向连接的套接字会发生数据丢失的问题.

还有一个需要强调的点:

套接字连接必须一一对应,
也就是说面向连接的套接字只能与另外一个同样是面向连接的套接字进行连接通信.
#### 套接字类型2:面向消息的套接字(`SOCK_DGRAM`)
如果向`socket`函数的第二个参数传递`SOCK_DGRAM`,则将创建面向消息的套接字.
那么面向消息的传输方式又是怎么样的呢?

面向消息的套接字可以比喻成高速移动的摩托车快递.

1. 强调快速传输而不是顺序传输
2. 传输的数据可能丢失,也可能损毁
3. 传输的数据有数据边界
4. 限制每次传输的数据大小

